#!/bin/bash

# Git pre-commit hook that uses Claude to check spelling in staged files
# This hook will prevent commits if spelling errors are found

echo "Running spellcheck on staged files..."

# Get list of staged files (text files only)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py|md|txt|js|ts|html|css|json|yaml|yml|sh)$' | head -20)

if [ -z "$STAGED_FILES" ]; then
    echo "No text files to spellcheck."
    exit 0
fi

# Create temporary file with staged content
TEMP_FILE=$(mktemp)
trap "rm -f $TEMP_FILE" EXIT

# Combine content of all staged files
for file in $STAGED_FILES; do
    echo "=== $file ===" >> "$TEMP_FILE"
    git show ":$file" >> "$TEMP_FILE"
    echo "" >> "$TEMP_FILE"
done

# Use Claude to check spelling
SPELLCHECK_RESULT=$(claude -p "Check the spelling in the following text. If there are any spelling errors, list them clearly with the word and suggested correction. If there are no spelling errors, respond with 'No spelling errors found.' Be concise and only focus on actual spelling mistakes, not grammar or style." < "$TEMP_FILE" 2>/dev/null)

# Check if Claude command succeeded
if [ $? -ne 0 ]; then
    echo "Warning: Could not run spellcheck with Claude"
    exit 0
fi

# Check if spelling errors were found
if echo "$SPELLCHECK_RESULT" | grep -q "No spelling errors found"; then
    echo "✓ Spellcheck passed"
    exit 0
else
    echo "✗ Spelling errors found:"
    echo "$SPELLCHECK_RESULT"
    echo ""
    echo "Please fix the spelling errors before committing."
    echo "To bypass this check, use: git commit --no-verify"
    exit 1
fi